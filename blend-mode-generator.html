<!DOCTYPE html>
<html>
<head>
    <title>CSS Blend Mode Layer Generator - img2css v2.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #222;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .workflow {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .step {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            text-align: center;
        }
        
        .step h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .step-number {
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        
        .controls {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            margin-bottom: 20px;
        }
        
        .file-input {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .generate-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .generate-btn:hover {
            background: #45a049;
        }
        
        .generate-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .preview-container {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
        }
        
        .preview-container h3 {
            color: #4CAF50;
            margin-top: 0;
            text-align: center;
        }
        
        .blend-demo {
            width: 100%;
            max-width: 500px;
            height: 300px;
            position: relative;
            border: 2px solid #666;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
            background: #000;
        }
        
        .layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .layer-base {
            background: var(--base-gradient, #999);
        }
        
        .layer-specular {
            background: var(--specular-gradient, transparent);
            mix-blend-mode: color-dodge;
        }
        
        .layer-shadows {
            background: var(--shadow-gradient, transparent);
            mix-blend-mode: multiply;
        }
        
        .layer-ambient {
            background: var(--ambient-gradient, transparent);
            mix-blend-mode: soft-light;
        }
        
        .layer-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .layer-toggle {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .layer-toggle.disabled {
            background: #666;
        }
        
        .layer-toggle:hover:not(.disabled) {
            background: #45a049;
        }
        
        .css-output {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
        }
        
        .css-output h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .css-code {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
        }
        
        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .copy-btn:hover {
            background: #1976D2;
        }
        
        .progress-indicator {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .progress-bar {
            background: #666;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            background: #4CAF50;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .blend-mode-selector {
            margin: 10px 0;
        }
        
        .blend-mode-selector label {
            color: #ccc;
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .blend-mode-selector select {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 5px;
            border-radius: 4px;
            width: 100%;
        }
        
        .status-log {
            background: #1e1e1e;
            color: #ccc;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.3;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® CSS Blend Mode Layer Generator</h1>
        <p style="text-align: center; color: #ccc; margin-bottom: 30px;">
            Convert lighting detection data into CSS blend mode layers for img2css v2.0
        </p>
        
        <div class="workflow">
            <div class="step">
                <div class="step-number">1</div>
                <h3>Analyze</h3>
                <p>Load image and detect lighting regions using HSV analysis</p>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <h3>Generate</h3>
                <p>Convert detection data into targeted CSS gradients with blend modes</p>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <h3>Preview</h3>
                <p>See real-time preview of layered blend mode effects</p>
            </div>
        </div>
        
        <div class="controls">
            <h3>üìÅ Load Image for Analysis</h3>
            <input type="file" id="imageInput" class="file-input" accept="image/*">
            <button id="generateBtn" class="generate-btn" onclick="generateBlendLayers()">
                üöÄ Generate Blend Mode Layers
            </button>
            
            <div id="progressIndicator" class="progress-indicator">
                <div>Processing image...</div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText">Starting analysis...</div>
            </div>
        </div>
        
        <div class="preview-grid">
            <div class="preview-container">
                <h3>üñºÔ∏è Original Image</h3>
                <canvas id="originalCanvas" style="max-width: 100%; border: 1px solid #666;"></canvas>
            </div>
            
            <div class="preview-container">
                <h3>‚ú® Blend Mode Preview</h3>
                <div class="blend-demo" id="blendDemo">
                    <div class="layer layer-base" id="layerBase"></div>
                    <div class="layer layer-specular" id="layerSpecular"></div>
                    <div class="layer layer-shadows" id="layerShadows"></div>
                    <div class="layer layer-ambient" id="layerAmbient"></div>
                </div>
                
                <div class="layer-controls">
                    <button class="layer-toggle" onclick="toggleLayer('layerBase')">Base Layer</button>
                    <button class="layer-toggle" onclick="toggleLayer('layerSpecular')">Specular (color-dodge)</button>
                    <button class="layer-toggle" onclick="toggleLayer('layerShadows')">Shadows (multiply)</button>
                    <button class="layer-toggle" onclick="toggleLayer('layerAmbient')">Ambient (soft-light)</button>
                </div>
                
                <div class="blend-mode-selector">
                    <label>Specular Blend Mode:</label>
                    <select id="specularBlendMode" onchange="updateBlendModes()">
                        <option value="color-dodge">color-dodge</option>
                        <option value="screen">screen</option>
                        <option value="lighten">lighten</option>
                        <option value="plus-lighter">plus-lighter</option>
                    </select>
                </div>
                
                <div class="blend-mode-selector">
                    <label>Shadow Blend Mode:</label>
                    <select id="shadowBlendMode" onchange="updateBlendModes()">
                        <option value="multiply" selected>multiply</option>
                        <option value="color-burn">color-burn</option>
                        <option value="darken">darken</option>
                        <option value="darker">darker</option>
                    </select>
                </div>
                
                <div class="blend-mode-selector">
                    <label>Ambient Blend Mode:</label>
                    <select id="ambientBlendMode" onchange="updateBlendModes()">
                        <option value="soft-light" selected>soft-light</option>
                        <option value="overlay">overlay</option>
                        <option value="hard-light">hard-light</option>
                        <option value="normal">normal</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="css-output">
            <h3>üìÑ Generated CSS Code</h3>
            <div id="cssCode" class="css-code">
                /* Load an image and click "Generate Blend Mode Layers" to see the CSS output */
            </div>
            <button class="copy-btn" onclick="copyCSSCode()">üìã Copy CSS Code</button>
            
            <div id="statusLog" class="status-log"></div>
        </div>
    </div>

    <script>
        let originalImageData = null;
        let detectionData = null;
        let generatedGradients = null;
        
        // Handle file input
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadImageFile(file);
            }
        });
        
        function loadImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    drawOriginalImage(img);
                    log('Image loaded successfully');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function drawOriginalImage(img) {
            const canvas = document.getElementById('originalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Resize canvas to fit image while maintaining aspect ratio
            const maxWidth = 400;
            const maxHeight = 300;
            let { width, height } = img;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(img, 0, 0, width, height);
            
            // Capture the image data for analysis
            originalImageData = ctx.getImageData(0, 0, width, height);
            
            document.getElementById('generateBtn').disabled = false;
        }
        
        function rgbToHsv(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const diff = max - min;
            
            let h = 0;
            if (diff !== 0) {
                switch (max) {
                    case r:
                        h = ((g - b) / diff) % 6;
                        break;
                    case g:
                        h = (b - r) / diff + 2;
                        break;
                    case b:
                        h = (r - g) / diff + 4;
                        break;
                }
            }
            h = Math.round(h * 60);
            if (h < 0) h += 360;
            
            const s = max === 0 ? 0 : diff / max;
            const v = max;
            
            return { h, s, v };
        }
        
        async function generateBlendLayers() {
            if (!originalImageData) {
                alert('Please load an image first!');
                return;
            }
            
            showProgress(true);
            updateProgress(10, 'Starting lighting analysis...');
            
            try {
                // Step 1: Analyze lighting
                updateProgress(20, 'Detecting specular highlights...');
                await sleep(100);
                const lightingData = analyzeLighting(originalImageData);
                
                // Step 2: Generate gradients
                updateProgress(50, 'Generating gradient layers...');
                await sleep(100);
                const gradients = generateGradientLayers(lightingData);
                
                // Step 3: Apply to preview
                updateProgress(80, 'Applying blend modes...');
                await sleep(100);
                applyGradientsToPreview(gradients);
                
                // Step 4: Generate CSS
                updateProgress(95, 'Generating CSS code...');
                await sleep(100);
                const cssCode = generateCSSCode(gradients);
                displayCSSCode(cssCode);
                
                updateProgress(100, 'Complete!');
                await sleep(500);
                showProgress(false);
                
                log('Blend mode layers generated successfully!');
                
            } catch (error) {
                log('Error: ' + error.message);
                showProgress(false);
            }
        }
        
        function analyzeLighting(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            const specularRegions = [];
            const shadowRegions = [];
            const ambientRegions = [];
            
            // Analyze in grid sections for gradient generation
            const gridSize = 20; // Analyze in 20x20 pixel blocks
            
            for (let y = 0; y < height; y += gridSize) {
                for (let x = 0; x < width; x += gridSize) {
                    const region = analyzeRegion(data, width, height, x, y, gridSize);
                    
                    if (region.type === 'specular') {
                        specularRegions.push(region);
                    } else if (region.type === 'shadow') {
                        shadowRegions.push(region);
                    } else if (region.type === 'ambient') {
                        ambientRegions.push(region);
                    }
                }
            }
            
            return {
                specular: specularRegions,
                shadow: shadowRegions,
                ambient: ambientRegions,
                width,
                height
            };
        }
        
        function analyzeRegion(data, width, height, startX, startY, blockSize) {
            let totalBrightness = 0;
            let totalSaturation = 0;
            let pixelCount = 0;
            let avgR = 0, avgG = 0, avgB = 0;
            
            for (let y = startY; y < Math.min(startY + blockSize, height); y++) {
                for (let x = startX; x < Math.min(startX + blockSize, width); x++) {
                    const index = (y * width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];
                    const a = data[index + 3];
                    
                    if (a === 0) continue;
                    
                    const { h, s, v } = rgbToHsv(r, g, b);
                    totalBrightness += v;
                    totalSaturation += s;
                    avgR += r;
                    avgG += g;
                    avgB += b;
                    pixelCount++;
                }
            }
            
            if (pixelCount === 0) return null;
            
            const avgBrightness = totalBrightness / pixelCount;
            const avgSaturation = totalSaturation / pixelCount;
            avgR = Math.round(avgR / pixelCount);
            avgG = Math.round(avgG / pixelCount);
            avgB = Math.round(avgB / pixelCount);
            
            const centerX = startX + blockSize / 2;
            const centerY = startY + blockSize / 2;
            const xPercent = (centerX / width) * 100;
            const yPercent = (centerY / height) * 100;
            
            let type = 'ambient';
            if (avgBrightness >= 0.8 && avgSaturation <= 0.3) {
                type = 'specular';
            } else if (avgBrightness <= 0.3) {
                type = 'shadow';
            }
            
            return {
                type,
                x: centerX,
                y: centerY,
                xPercent,
                yPercent,
                brightness: avgBrightness,
                saturation: avgSaturation,
                color: { r: avgR, g: avgG, b: avgB },
                intensity: type === 'specular' ? avgBrightness : 
                          type === 'shadow' ? (1 - avgBrightness) : 
                          avgSaturation
            };
        }
        
        function generateGradientLayers(lightingData) {
            // Generate specular highlights gradient
            const specularGradient = generateSpecularGradient(lightingData.specular, lightingData.width, lightingData.height);
            
            // Generate shadow gradient
            const shadowGradient = generateShadowGradient(lightingData.shadow, lightingData.width, lightingData.height);
            
            // Generate ambient gradient
            const ambientGradient = generateAmbientGradient(lightingData.ambient, lightingData.width, lightingData.height);
            
            // Generate base gradient (simplified version of original)
            const baseGradient = generateBaseGradient(lightingData);
            
            return {
                base: baseGradient,
                specular: specularGradient,
                shadow: shadowGradient,
                ambient: ambientGradient
            };
        }
        
        function generateSpecularGradient(specularRegions, width, height) {
            if (specularRegions.length === 0) {
                return 'transparent';
            }
            
            // Create radial gradients for bright highlights
            const gradients = specularRegions
                .filter(region => region.intensity > 0.7)
                .slice(0, 5) // Limit to top 5 highlights
                .map(region => {
                    const size = Math.min(30 + region.intensity * 50, 80);
                    return `radial-gradient(ellipse ${size}px ${size * 0.6}px at ${region.xPercent}% ${region.yPercent}%, 
                        rgba(255, 255, 255, ${region.intensity * 0.8}) 0%, 
                        rgba(255, 255, 255, ${region.intensity * 0.3}) 50%, 
                        transparent 80%)`;
                });
            
            return gradients.length > 0 ? gradients.join(', ') : 'transparent';
        }
        
        function generateShadowGradient(shadowRegions, width, height) {
            if (shadowRegions.length === 0) {
                return 'transparent';
            }
            
            // Create a general shadow overlay
            const darkAreas = shadowRegions.filter(region => region.intensity > 0.5);
            
            if (darkAreas.length === 0) return 'transparent';
            
            // Generate a gradient that emphasizes shadow areas
            const gradientStops = [];
            
            // Sort by Y position for vertical gradient
            darkAreas.sort((a, b) => a.yPercent - b.yPercent);
            
            darkAreas.slice(0, 8).forEach((region, index) => {
                const opacity = region.intensity * 0.6;
                gradientStops.push(`rgba(0, 0, 0, ${opacity}) ${region.yPercent}%`);
            });
            
            if (gradientStops.length > 0) {
                return `linear-gradient(to bottom, ${gradientStops.join(', ')})`;
            }
            
            return 'rgba(0, 0, 0, 0.3)';
        }
        
        function generateAmbientGradient(ambientRegions, width, height) {
            if (ambientRegions.length === 0) {
                return 'transparent';
            }
            
            // Create subtle ambient lighting effects
            const lightAreas = ambientRegions.filter(region => region.brightness > 0.4);
            
            if (lightAreas.length === 0) return 'transparent';
            
            // Use the dominant color from ambient regions
            const avgColor = lightAreas.reduce((acc, region) => {
                acc.r += region.color.r;
                acc.g += region.color.g;
                acc.b += region.color.b;
                return acc;
            }, { r: 0, g: 0, b: 0 });
            
            avgColor.r = Math.round(avgColor.r / lightAreas.length);
            avgColor.g = Math.round(avgColor.g / lightAreas.length);
            avgColor.b = Math.round(avgColor.b / lightAreas.length);
            
            return `radial-gradient(ellipse at 50% 40%, 
                rgba(${avgColor.r}, ${avgColor.g}, ${avgColor.b}, 0.3) 0%, 
                rgba(${avgColor.r}, ${avgColor.g}, ${avgColor.b}, 0.1) 60%, 
                transparent 100%)`;
        }
        
        function generateBaseGradient(lightingData) {
            // Create a simplified base gradient representing the overall image structure
            const allRegions = [
                ...lightingData.specular,
                ...lightingData.shadow,
                ...lightingData.ambient
            ];
            
            if (allRegions.length === 0) {
                return '#999999';
            }
            
            // Sort regions by position and create a basic gradient
            allRegions.sort((a, b) => a.xPercent - b.xPercent);
            
            const gradientStops = allRegions.slice(0, 10).map(region => {
                const { r, g, b } = region.color;
                return `rgb(${r}, ${g}, ${b}) ${region.xPercent}%`;
            });
            
            return `linear-gradient(to right, ${gradientStops.join(', ')})`;
        }
        
        function applyGradientsToPreview(gradients) {
            const demo = document.getElementById('blendDemo');
            
            demo.style.setProperty('--base-gradient', gradients.base);
            demo.style.setProperty('--specular-gradient', gradients.specular);
            demo.style.setProperty('--shadow-gradient', gradients.shadow);
            demo.style.setProperty('--ambient-gradient', gradients.ambient);
            
            generatedGradients = gradients;
        }
        
        function generateCSSCode(gradients) {
            const specularBlendMode = document.getElementById('specularBlendMode').value;
            const shadowBlendMode = document.getElementById('shadowBlendMode').value;
            const ambientBlendMode = document.getElementById('ambientBlendMode').value;
            
            return `/* img2css v2.0 - CSS Blend Mode Layers */
.img2css-shader {
    position: relative;
    width: 100%;
    height: auto;
    aspect-ratio: ${originalImageData.width} / ${originalImageData.height};
}

.img2css-base {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: ${gradients.base};
}

.img2css-specular {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: ${gradients.specular};
    mix-blend-mode: ${specularBlendMode};
    pointer-events: none;
}

.img2css-shadows {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: ${gradients.shadow};
    mix-blend-mode: ${shadowBlendMode};
    pointer-events: none;
}

.img2css-ambient {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: ${gradients.ambient};
    mix-blend-mode: ${ambientBlendMode};
    pointer-events: none;
}

/* HTML Structure:
<div class="img2css-shader">
    <div class="img2css-base"></div>
    <div class="img2css-specular"></div>
    <div class="img2css-shadows"></div>
    <div class="img2css-ambient"></div>
</div>
*/`;
        }
        
        function displayCSSCode(cssCode) {
            document.getElementById('cssCode').textContent = cssCode;
        }
        
        function copyCSSCode() {
            const cssCode = document.getElementById('cssCode').textContent;
            navigator.clipboard.writeText(cssCode).then(() => {
                log('CSS code copied to clipboard!');
            });
        }
        
        function toggleLayer(layerId) {
            const layer = document.getElementById(layerId);
            const button = event.target;
            
            if (layer.style.display === 'none') {
                layer.style.display = 'block';
                button.classList.remove('disabled');
            } else {
                layer.style.display = 'none';
                button.classList.add('disabled');
            }
        }
        
        function updateBlendModes() {
            if (generatedGradients) {
                const specularBlendMode = document.getElementById('specularBlendMode').value;
                const shadowBlendMode = document.getElementById('shadowBlendMode').value;
                const ambientBlendMode = document.getElementById('ambientBlendMode').value;
                
                document.getElementById('layerSpecular').style.mixBlendMode = specularBlendMode;
                document.getElementById('layerShadows').style.mixBlendMode = shadowBlendMode;
                document.getElementById('layerAmbient').style.mixBlendMode = ambientBlendMode;
                
                // Update CSS code
                const cssCode = generateCSSCode(generatedGradients);
                displayCSSCode(cssCode);
            }
        }
        
        function showProgress(show) {
            document.getElementById('progressIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('generateBtn').disabled = show;
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function log(message) {
            const logEl = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>