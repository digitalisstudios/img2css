<!DOCTYPE html>
<html>
<head>
    <title>img2css v2.0 - Callback System Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #222;
            color: white;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .app-layout {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }
        
        .fixed-header {
            background: #1a1a1a;
            border-bottom: 2px solid #333;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 30px;
            align-items: center;
            z-index: 1000;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 890px;
            height: calc(100vh - 70px);
        }
        
        .preview-area {
            padding: 20px;
            overflow-y: auto;
            background: #1e1e1e;
        }
        
        .controls-sidebar {
            background: #2a2a2a;
            border-left: 2px solid #333;
            overflow-y: auto;
            padding: 20px;
        }
        
        .header-title h1 {
            color: #4CAF50;
            margin: 0;
            font-size: 20px;
        }
        
        .header-title p {
            color: #999;
            margin: 5px 0 0 0;
            font-size: 12px;
        }
        
        .header-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .compact-file-input {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .compact-generate-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .compact-generate-btn:hover {
            background: #45a049;
        }
        
        .header-stats {
            font-size: 11px;
            color: #999;
            text-align: right;
            min-width: 200px;
        }
        
        .header-stats .stat-line {
            margin: 2px 0;
        }
        
        .demo-explanation {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
            margin-bottom: 30px;
        }
        
        .demo-explanation h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .controls {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            margin-bottom: 20px;
        }
        
        .file-input {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .generate-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .generate-btn:hover {
            background: #45a049;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .preview-container {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
        }
        
        .preview-container h3 {
            color: #4CAF50;
            margin-top: 0;
            text-align: center;
            font-size: 16px;
        }
        
        .layer-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        .layer-toggle {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .blend-demo {
            width: 100%;
            height: 250px;
            position: relative;
            border: 2px solid #666;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
            background: #000;
        }
        
        .blend-demo.auto-aspect {
            height: auto;
            aspect-ratio: var(--image-aspect-ratio, 1);
        }
        
        .layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .layer-base {
            background: var(--generated-gradient, #999);
        }
        
        .shader {
            position: relative;
            overflow: hidden;
            backface-visibility: hidden;
        }
        
        .shader__layer {
            background: black;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-size: 100%;
            pointer-events: none;
        }
        
        #layerToneSpecular {
            mix-blend-mode: color-dodge;
        }
        
        #layerToneReflection {
            mix-blend-mode: soft-light;
        }
        
        #layerToneShadow {
            mix-blend-mode: multiply;
        }
        
        .shader-layer {
            background: black;
            mix-blend-mode: multiply;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-position: center;
        }
        
        .shader-layer.specular {
            mix-blend-mode: color-dodge;
            background-attachment: fixed;
            background-size: 100% 100%;
            background-repeat: repeat;
            background-position: center;
        }
        
        .shader-layer.reflection {
            mix-blend-mode: soft-light;
            background-attachment: fixed;
        }
        
        .shader-layer.shadow {
            mix-blend-mode: multiply;
            background-attachment: fixed;
        }
        
        .mask {
            mix-blend-mode: multiply !important;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #specularMask {
            filter: blur(0.1px);
        }
        
        .layer-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .layer-toggle {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .layer-toggle.disabled {
            background: #666;
        }
        
        .layer-toggle:hover:not(.disabled) {
            background: #45a049;
        }
        
        .effect-controls {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .control-group {
            display: grid;
            grid-template-columns: auto 60px auto 50px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .controls-sidebar .control-section {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #555;
        }
        
        .controls-sidebar h2 {
            color: #4CAF50;
            margin: 0 0 20px 0;
            font-size: 18px;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .control-separator {
            border-top: 1px solid #555;
            margin: 20px 0 15px 0;
            padding-top: 15px;
            position: relative;
        }
        
        .control-separator::before {
            content: attr(data-label);
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #999;
            font-size: 11px;
            padding: 0 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-section h4 {
            color: #4CAF50;
            margin: 0;
            font-size: 16px;
        }
        
        .section-toggle {
            background: transparent;
            color: #4CAF50;
            border: none;
            padding: 2px;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        
        .section-toggle:hover {
            color: #45a049;
        }
        
        .section-toggle.disabled {
            color: #666;
        }
        
        .section-toggle.disabled:hover {
            color: #777;
        }
        
        .section-toggle::before {
            content: "üëÅ";
        }
        
        .section-toggle.disabled::before {
            content: "üö´";
        }
        
        .control-section.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .control-section.disabled .section-toggle {
            opacity: 1;
            pointer-events: auto;
        }
        
        .control-section.collapsed .control-panel {
            display: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .collapse-btn {
            background: transparent;
            color: #ccc;
            border: none;
            padding: 2px;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        
        .collapse-btn:hover {
            color: #4CAF50;
        }
        
        .collapse-btn::before {
            content: "‚ñ∂";
            transition: transform 0.2s;
        }
        
        .control-section:not(.collapsed) .collapse-btn::before {
            transform: rotate(90deg);
        }
        
        .control-section {
            display: grid;
            grid-template-columns: 1fr 180px;
            grid-template-rows: auto 1fr;
            gap: 15px;
        }
        
        .section-header {
            grid-column: 1;
            grid-row: 1;
        }
        
        .control-panel {
            grid-column: 1;
            grid-row: 2;
        }
        
        .mask-panel {
            grid-column: 2;
            grid-row: 1 / -1;
            align-self: start;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .mask-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .mask-panel h5 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-size: 14px;
            text-align: center;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-item label {
            color: #ccc;
            font-size: 12px;
            font-weight: 500;
        }
        
        .control-with-input {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .control-with-input input[type="range"] {
            flex: 1;
        }
        
        .numeric-input {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 4px 6px;
            border-radius: 4px;
            width: 50px;
            font-size: 10px;
            text-align: center;
        }
        
        .numeric-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .control-row-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .control-row-triple {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        
        .blend-mode-select {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .blend-mode-select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .invert-btn {
            background: #666;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: background 0.2s;
        }
        
        .invert-btn:hover {
            background: #777;
        }
        
        .invert-btn.active {
            background: #ff6b6b;
        }
        
        .control-group label {
            color: #ccc;
        }
        
        .control-group input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .control-group input[type="range"],
        .color-row input[type="range"],
        .control-row input[type="range"],
        .mask-control-row input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #555;
            border-radius: 3px;
            outline: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb,
        .color-row input[type="range"]::-webkit-slider-thumb,
        .control-row input[type="range"]::-webkit-slider-thumb,
        .mask-control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .control-group input[type="range"]::-moz-range-thumb,
        .color-row input[type="range"]::-moz-range-thumb,
        .control-row input[type="range"]::-moz-range-thumb,
        .mask-control-row input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .control-group span {
            color: #4CAF50;
            font-weight: bold;
            text-align: center;
        }
        
        .masks-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .mask-preview {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .mask-preview h4 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        
        .mask-canvas {
            width: 100%;
            max-width: 200px;
            border: 1px solid #666;
            border-radius: 4px;
        }
        
        .stats {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            margin-bottom: 20px;
        }
        
        .stats h3 {
            color: #4CAF50;
            margin-top: 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #ccc;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.3;
            margin-top: 20px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <header class="fixed-header">
            <div class="header-title">
                <h1>üîß img2css v2.0 - Callback System Demo</h1>
                <p>Plugin system with perfect tone mask alignment</p>
            </div>
            
            
        </header>
        
        <div class="main-content">
            <div class="preview-area">
                <div style="margin-bottom: 15px;">
                    <input type="file" id="imageInput" class="compact-file-input" accept="image/*" style="width: 100%; padding: 10px; font-size: 14px; box-sizing: border-box;">
                </div>
                
                <div class="header-stats" id="headerStats" style="font-size: 11px; color: #999; margin-bottom: 15px; padding: 10px; background: #333; border-radius: 4px;">
                    <div class="stat-line">Ready to process</div>
                    <div class="stat-line">Load an image to begin</div>
                </div>
        
                <div class="preview-container" style="max-width: 600px; margin: 0 auto;">
                    <h3>‚ú® Enhanced with Plugin Tone Masks</h3>
                    <div class="blend-demo auto-aspect shader" id="enhancedDemo">
                        <div class="layer layer-base" id="layerBaseEnhanced"></div>
                        <div class="shader-layer specular" id="layerToneSpecular"></div>
                        <div class="shader-layer reflection" id="layerToneReflection"></div>
                        <div class="shader-layer shadow" id="layerToneShadow"></div>
                    </div>
                    
                    <div class="layer-controls">
                        <button class="layer-toggle" onclick="toggleLayer('layerBaseEnhanced')">Base</button>
                        <button class="layer-toggle" onclick="toggleLayer('layerToneSpecular')">Specular</button>
                        <button class="layer-toggle" onclick="toggleLayer('layerToneReflection')">Reflection</button>
                        <button class="layer-toggle" onclick="toggleLayer('layerToneShadow')">Shadow</button>
                    </div>
                </div>
                
                <div id="logContainer" class="log-container" style="min-height: 100vh; font-size: 10px; margin-top: 20px;"></div>
            </div>
            
            <div class="controls-sidebar">
                <h2>üéõÔ∏è Effect Controls</h2>
                    
                    <div class="control-section" id="specularSection">
                        <div class="section-header">
                            <div class="section-title">
                                <button class="collapse-btn" id="specularCollapseBtn" onclick="toggleCollapse('specular')"></button>
                                <button class="section-toggle" id="specularToggle" onclick="toggleSection('specular')"></button>
                                <h4 style="margin: 0;">Specular Highlights</h4>
                            </div>
                        </div>
                        
                        <div class="control-panel" id="specularControlPanel">
                            
                            <div class="control-row-triple">
                                <div class="control-item">
                                    <label>Start: <span id="specularAlpha1Value">Œ± 0.49</span></label>
                                    <input type="color" id="specularColor1" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="specularAlpha1" min="0" max="1" step="0.01" value="0.49" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="specularAlpha1Input" min="0" max="1" step="0.01" value="0.49" onchange="syncSliderFromInput('specularAlpha1', 'specularAlpha1Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="specularPos1Value">27</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="specularPos1" min="0" max="100" step="1" value="27" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="specularPos1Input" min="0" max="100" step="1" value="27" onchange="syncSliderFromInput('specularPos1', 'specularPos1Input'); updateEffects()">
                                    </div>
                                </div>
                                <div class="control-item">
                                    <label>Mid: <span id="specularAlpha2Value">Œ± 0.76</span></label>
                                    <input type="color" id="specularColor2" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="specularAlpha2" min="0" max="1" step="0.01" value="0.76" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="specularAlpha2Input" min="0" max="1" step="0.01" value="0.76" onchange="syncSliderFromInput('specularAlpha2', 'specularAlpha2Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="specularPos2Value">29</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="specularPos2" min="0" max="100" step="1" value="29" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="specularPos2Input" min="0" max="100" step="1" value="29" onchange="syncSliderFromInput('specularPos2', 'specularPos2Input'); updateEffects()">
                                    </div>
                                </div>
                                <div class="control-item">
                                    <label>End: <span id="specularAlpha3Value">Œ± 0.54</span></label>
                                    <input type="color" id="specularColor3" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="specularAlpha3" min="0" max="1" step="0.01" value="0.54" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="specularAlpha3Input" min="0" max="1" step="0.01" value="0.54" onchange="syncSliderFromInput('specularAlpha3', 'specularAlpha3Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="specularPos3Value">37</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="specularPos3" min="0" max="100" step="1" value="37" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="specularPos3Input" min="0" max="100" step="1" value="37" onchange="syncSliderFromInput('specularPos3', 'specularPos3Input'); updateEffects()">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Layer Opacity: <span id="specularOpacityValue">1</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="specularOpacity" min="0" max="1" step="0.01" value="1" oninput="updateEffects()">
                                    <input type="number" class="numeric-input" id="specularOpacityInput" min="0" max="1" step="0.01" value="1" onchange="syncSliderFromInput('specularOpacity', 'specularOpacityInput'); updateEffects()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Angle: <span id="specularAngleValue">175</span>¬∞</label>
                                <div class="control-with-input">
                                    <input type="range" id="specularAngleSlider" min="0" max="360" step="1" value="175" oninput="updateEffects()">
                                    <input type="number" class="numeric-input" id="specularAngleInput" min="0" max="360" step="1" value="175" onchange="syncSliderFromInput('specularAngleSlider', 'specularAngleInput'); updateEffects()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Blend Mode</label>
                                <select class="blend-mode-select" id="specularBlendMode" onchange="updateEffects()">
                                    <option value="normal">normal</option>
                                    <option value="multiply">multiply</option>
                                    <option value="screen">screen</option>
                                    <option value="overlay">overlay</option>
                                    <option value="darken">darken</option>
                                    <option value="lighten">lighten</option>
                                    <option value="color-dodge" selected>color-dodge</option>
                                    <option value="color-burn">color-burn</option>
                                    <option value="hard-light">hard-light</option>
                                    <option value="soft-light">soft-light</option>
                                    <option value="difference">difference</option>
                                    <option value="exclusion">exclusion</option>
                                    <option value="hue">hue</option>
                                    <option value="saturation">saturation</option>
                                    <option value="color">color</option>
                                    <option value="luminosity">luminosity</option>
                                    <option value="plus-darker">plus-darker</option>
                                    <option value="plus-lighter">plus-lighter</option>
                                </select>
                            </div>
                            
                            <div class="control-separator" data-label="MASK CONTROLS"></div>
                            
                            <div class="control-item">
                                <label>Mask Invert</label>
                                <button class="invert-btn" id="specularInvert" onclick="toggleInvert('specular')">Invert</button>
                            </div>
                            
                            <div class="control-item">
                                <label>White Point: <span id="specularWhitePointValue">60</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="specularWhitePointSlider" min="0" max="255" step="1" value="60" oninput="updateSpecularMask()">
                                    <input type="number" class="numeric-input" id="specularWhitePointInput" min="0" max="255" step="1" value="60" onchange="syncSliderFromInput('specularWhitePointSlider', 'specularWhitePointInput'); updateSpecularMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Black Point: <span id="specularBlackPointValue">36</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="specularBlackPointSlider" min="0" max="255" step="1" value="36" oninput="updateSpecularMask()">
                                    <input type="number" class="numeric-input" id="specularBlackPointInput" min="0" max="255" step="1" value="36" onchange="syncSliderFromInput('specularBlackPointSlider', 'specularBlackPointInput'); updateSpecularMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Contrast: <span id="specularContrastValue">2.07</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="specularContrastSlider" min="0.5" max="3" step="0.01" value="2.07" oninput="updateSpecularMask()">
                                    <input type="number" class="numeric-input" id="specularContrastInput" min="0.5" max="3" step="0.01" value="2.07" onchange="syncSliderFromInput('specularContrastSlider', 'specularContrastInput'); updateSpecularMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Blur: <span id="specularBlurValue">5</span>px</label>
                                <div class="control-with-input">
                                    <input type="range" id="specularBlurSlider" min="0" max="5" step="0.1" value="5" oninput="updateSpecularBlur()">
                                    <input type="number" class="numeric-input" id="specularBlurInput" min="0" max="5" step="0.1" value="5" onchange="syncSliderFromInput('specularBlurSlider', 'specularBlurInput'); updateSpecularBlur()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mask-panel">
                            <canvas id="specularMaskCanvas" class="mask-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="control-section" id="reflectionSection">
                        <div class="section-header">
                            <div class="section-title">
                                <button class="collapse-btn" id="reflectionCollapseBtn" onclick="toggleCollapse('reflection')"></button>
                                <button class="section-toggle" id="reflectionToggle" onclick="toggleSection('reflection')"></button>
                                <h4 style="margin: 0;">Reflections</h4>
                            </div>
                        </div>
                        
                        <div class="control-panel" id="reflectionControlPanel">
                            
                            <div class="control-row-triple">
                                <div class="control-item">
                                    <label>Start: <span id="reflectionAlpha1Value">Œ± 0.46</span></label>
                                    <input type="color" id="reflectionColor1" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="reflectionAlpha1" min="0" max="1" step="0.01" value="0.46" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="reflectionAlpha1Input" min="0" max="1" step="0.01" value="0.46" onchange="syncSliderFromInput('reflectionAlpha1', 'reflectionAlpha1Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="reflectionPos1Value">47</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="reflectionPos1" min="0" max="100" step="1" value="47" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="reflectionPos1Input" min="0" max="100" step="1" value="47" onchange="syncSliderFromInput('reflectionPos1', 'reflectionPos1Input'); updateEffects()">
                                    </div>
                                </div>
                                <div class="control-item">
                                    <label>Mid: <span id="reflectionAlpha2Value">Œ± 0.18</span></label>
                                    <input type="color" id="reflectionColor2" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="reflectionAlpha2" min="0" max="1" step="0.01" value="0.18" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="reflectionAlpha2Input" min="0" max="1" step="0.01" value="0.18" onchange="syncSliderFromInput('reflectionAlpha2', 'reflectionAlpha2Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="reflectionPos2Value">52</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="reflectionPos2" min="0" max="100" step="1" value="52" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="reflectionPos2Input" min="0" max="100" step="1" value="52" onchange="syncSliderFromInput('reflectionPos2', 'reflectionPos2Input'); updateEffects()">
                                    </div>
                                </div>
                                <div class="control-item">
                                    <label>End: <span id="reflectionAlpha3Value">Œ± 0.43</span></label>
                                    <input type="color" id="reflectionColor3" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="reflectionAlpha3" min="0" max="1" step="0.01" value="0.43" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="reflectionAlpha3Input" min="0" max="1" step="0.01" value="0.43" onchange="syncSliderFromInput('reflectionAlpha3', 'reflectionAlpha3Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="reflectionPos3Value">64</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="reflectionPos3" min="0" max="100" step="1" value="64" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="reflectionPos3Input" min="0" max="100" step="1" value="64" onchange="syncSliderFromInput('reflectionPos3', 'reflectionPos3Input'); updateEffects()">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Layer Opacity: <span id="reflectionOpacityValue">0.66</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="reflectionOpacity" min="0" max="1" step="0.01" value="0.66" oninput="updateEffects()">
                                    <input type="number" class="numeric-input" id="reflectionOpacityInput" min="0" max="1" step="0.01" value="0.66" onchange="syncSliderFromInput('reflectionOpacity', 'reflectionOpacityInput'); updateEffects()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Angle: <span id="reflectionAngleValue">191</span>¬∞</label>
                                <div class="control-with-input">
                                    <input type="range" id="reflectionAngleSlider" min="0" max="360" step="1" value="191" oninput="updateEffects()">
                                    <input type="number" class="numeric-input" id="reflectionAngleInput" min="0" max="360" step="1" value="191" onchange="syncSliderFromInput('reflectionAngleSlider', 'reflectionAngleInput'); updateEffects()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Blend Mode</label>
                                <select class="blend-mode-select" id="reflectionBlendMode" onchange="updateEffects()">
                                    <option value="normal">normal</option>
                                    <option value="multiply">multiply</option>
                                    <option value="screen">screen</option>
                                    <option value="overlay">overlay</option>
                                    <option value="darken">darken</option>
                                    <option value="lighten">lighten</option>
                                    <option value="color-dodge">color-dodge</option>
                                    <option value="color-burn" selected>color-burn</option>
                                    <option value="hard-light">hard-light</option>
                                    <option value="soft-light">soft-light</option>
                                    <option value="difference">difference</option>
                                    <option value="exclusion">exclusion</option>
                                    <option value="hue">hue</option>
                                    <option value="saturation">saturation</option>
                                    <option value="color">color</option>
                                    <option value="luminosity">luminosity</option>
                                    <option value="plus-darker">plus-darker</option>
                                    <option value="plus-lighter">plus-lighter</option>
                                </select>
                            </div>
                            
                            <div class="control-separator" data-label="MASK CONTROLS"></div>
                            
                            <div class="control-item">
                                <label>Mask Invert</label>
                                <button class="invert-btn" id="reflectionInvert" onclick="toggleInvert('reflection')">Invert</button>
                            </div>
                            
                            <div class="control-item">
                                <label>White Point: <span id="reflectionWhitePointValue">45</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="reflectionWhitePointSlider" min="0" max="255" step="1" value="45" oninput="updateReflectionMask()">
                                    <input type="number" class="numeric-input" id="reflectionWhitePointInput" min="0" max="255" step="1" value="45" onchange="syncSliderFromInput('reflectionWhitePointSlider', 'reflectionWhitePointInput'); updateReflectionMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Black Point: <span id="reflectionBlackPointValue">44</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="reflectionBlackPointSlider" min="0" max="255" step="1" value="44" oninput="updateReflectionMask()">
                                    <input type="number" class="numeric-input" id="reflectionBlackPointInput" min="0" max="255" step="1" value="44" onchange="syncSliderFromInput('reflectionBlackPointSlider', 'reflectionBlackPointInput'); updateReflectionMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Contrast: <span id="reflectionContrastValue">1.09</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="reflectionContrastSlider" min="0.5" max="3" step="0.01" value="1.09" oninput="updateReflectionMask()">
                                    <input type="number" class="numeric-input" id="reflectionContrastInput" min="0.5" max="3" step="0.01" value="1.09" onchange="syncSliderFromInput('reflectionContrastSlider', 'reflectionContrastInput'); updateReflectionMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Blur: <span id="reflectionBlurValue">4.2</span>px</label>
                                <div class="control-with-input">
                                    <input type="range" id="reflectionBlurSlider" min="0" max="5" step="0.1" value="4.2" oninput="updateReflectionBlur()">
                                    <input type="number" class="numeric-input" id="reflectionBlurInput" min="0" max="5" step="0.1" value="4.2" onchange="syncSliderFromInput('reflectionBlurSlider', 'reflectionBlurInput'); updateReflectionBlur()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mask-panel">
                            <canvas id="reflectionMaskCanvas" class="mask-canvas"></canvas>
                        </div>
                    </div>
                    
                    <div class="control-section" id="shadowSection">
                        <div class="section-header">
                            <div class="section-title">
                                <button class="collapse-btn" id="shadowCollapseBtn" onclick="toggleCollapse('shadow')"></button>
                                <button class="section-toggle" id="shadowToggle" onclick="toggleSection('shadow')"></button>
                                <h4 style="margin: 0;">Shadows</h4>
                            </div>
                        </div>
                        
                        <div class="control-panel" id="shadowControlPanel">
                            
                            <div class="control-row-triple">
                                <div class="control-item">
                                    <label>Start: <span id="shadowAlpha1Value">Œ± 0.35</span></label>
                                    <input type="color" id="shadowColor1" value="#000000" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="shadowAlpha1" min="0" max="1" step="0.01" value="0.35" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="shadowAlpha1Input" min="0" max="1" step="0.01" value="0.35" onchange="syncSliderFromInput('shadowAlpha1', 'shadowAlpha1Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="shadowPos1Value">0</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="shadowPos1" min="0" max="100" step="1" value="0" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="shadowPos1Input" min="0" max="100" step="1" value="0" onchange="syncSliderFromInput('shadowPos1', 'shadowPos1Input'); updateEffects()">
                                    </div>
                                </div>
                                <div class="control-item">
                                    <label>Mid: <span id="shadowAlpha2Value">Œ± 1</span></label>
                                    <input type="color" id="shadowColor2" value="#ffffff" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="shadowAlpha2" min="0" max="1" step="0.01" value="1" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="shadowAlpha2Input" min="0" max="1" step="0.01" value="1" onchange="syncSliderFromInput('shadowAlpha2', 'shadowAlpha2Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="shadowPos2Value">50</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="shadowPos2" min="0" max="100" step="1" value="50" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="shadowPos2Input" min="0" max="100" step="1" value="50" onchange="syncSliderFromInput('shadowPos2', 'shadowPos2Input'); updateEffects()">
                                    </div>
                                </div>
                                <div class="control-item">
                                    <label>End: <span id="shadowAlpha3Value">Œ± 1</span></label>
                                    <input type="color" id="shadowColor3" value="#000000" onchange="updateEffects()">
                                    <div class="control-with-input">
                                        <input type="range" id="shadowAlpha3" min="0" max="1" step="0.01" value="1" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="shadowAlpha3Input" min="0" max="1" step="0.01" value="1" onchange="syncSliderFromInput('shadowAlpha3', 'shadowAlpha3Input'); updateEffects()">
                                    </div>
                                    <label>Position: <span id="shadowPos3Value">100</span>%</label>
                                    <div class="control-with-input">
                                        <input type="range" id="shadowPos3" min="0" max="100" step="1" value="100" oninput="updateEffects()">
                                        <input type="number" class="numeric-input" id="shadowPos3Input" min="0" max="100" step="1" value="100" onchange="syncSliderFromInput('shadowPos3', 'shadowPos3Input'); updateEffects()">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Layer Opacity: <span id="shadowOpacityValue">0.6</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="shadowOpacity" min="0" max="1" step="0.01" value="0.6" oninput="updateEffects()">
                                    <input type="number" class="numeric-input" id="shadowOpacityInput" min="0" max="1" step="0.01" value="0.6" onchange="syncSliderFromInput('shadowOpacity', 'shadowOpacityInput'); updateEffects()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Blend Mode</label>
                                <select class="blend-mode-select" id="shadowBlendMode" onchange="updateEffects()">
                                    <option value="normal">normal</option>
                                    <option value="multiply" selected>multiply</option>
                                    <option value="screen">screen</option>
                                    <option value="overlay">overlay</option>
                                    <option value="darken">darken</option>
                                    <option value="lighten">lighten</option>
                                    <option value="color-dodge">color-dodge</option>
                                    <option value="color-burn">color-burn</option>
                                    <option value="hard-light">hard-light</option>
                                    <option value="soft-light">soft-light</option>
                                    <option value="difference">difference</option>
                                    <option value="exclusion">exclusion</option>
                                    <option value="hue">hue</option>
                                    <option value="saturation">saturation</option>
                                    <option value="color">color</option>
                                    <option value="luminosity">luminosity</option>
                                    <option value="plus-darker">plus-darker</option>
                                    <option value="plus-lighter">plus-lighter</option>
                                </select>
                            </div>
                            
                            <div class="control-separator" data-label="MASK CONTROLS"></div>
                            
                            <div class="control-item">
                                <label>Mask Invert</label>
                                <button class="invert-btn" id="shadowInvert" onclick="toggleInvert('shadow')">Invert</button>
                            </div>
                            
                            <div class="control-item">
                                <label>White Point: <span id="shadowWhitePointValue">173</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="shadowWhitePointSlider" min="0" max="255" step="1" value="173" oninput="updateShadowMask()">
                                    <input type="number" class="numeric-input" id="shadowWhitePointInput" min="0" max="255" step="1" value="173" onchange="syncSliderFromInput('shadowWhitePointSlider', 'shadowWhitePointInput'); updateShadowMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Black Point: <span id="shadowBlackPointValue">122</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="shadowBlackPointSlider" min="0" max="255" step="1" value="122" oninput="updateShadowMask()">
                                    <input type="number" class="numeric-input" id="shadowBlackPointInput" min="0" max="255" step="1" value="122" onchange="syncSliderFromInput('shadowBlackPointSlider', 'shadowBlackPointInput'); updateShadowMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Contrast: <span id="shadowContrastValue">0.71</span></label>
                                <div class="control-with-input">
                                    <input type="range" id="shadowContrastSlider" min="0.5" max="3" step="0.01" value="0.71" oninput="updateShadowMask()">
                                    <input type="number" class="numeric-input" id="shadowContrastInput" min="0.5" max="3" step="0.01" value="0.71" onchange="syncSliderFromInput('shadowContrastSlider', 'shadowContrastInput'); updateShadowMask()">
                                </div>
                            </div>
                            
                            <div class="control-item">
                                <label>Blur: <span id="shadowBlurValue">1.2</span>px</label>
                                <div class="control-with-input">
                                    <input type="range" id="shadowBlurSlider" min="0" max="5" step="0.1" value="1.2" oninput="updateShadowBlur()">
                                    <input type="number" class="numeric-input" id="shadowBlurInput" min="0" max="5" step="0.1" value="1.2" onchange="syncSliderFromInput('shadowBlurSlider', 'shadowBlurInput'); updateShadowBlur()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mask-panel">
                            <canvas id="shadowMaskCanvas" class="mask-canvas"></canvas>
                        </div>
                    </div>
                
            </div>
        </div>
    </div>

    <script src="src/img2css.js"></script>
    <script>
        let originalImageData = null;
        let toneMaskData = null;
        let processingStats = null;
        
        // Tone analysis plugin data
        let specularPixels = [];
        let reflectionPixels = [];
        let shadowPixels = [];
        let totalPixelsProcessed = 0;
        let totalRowsProcessed = 0;
        let totalColumnsProcessed = 0;
        
        // Invert states for each mask
        let maskInvertStates = {
            specular: true,
            reflection: true,
            shadow: true
        };
        
        // Enable/disable states for each section
        let sectionEnabledStates = {
            specular: true,
            reflection: true,
            shadow: true
        };
        
        // Collapse states for each section
        let sectionCollapsedStates = {
            specular: false,
            reflection: false,
            shadow: false
        };
        
        function log(message) {
            const logEl = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${timestamp}] ${message}<br><br>` + logEl.innerHTML;
            // Keep only the last 50 messages to prevent infinite growth
            const entries = logEl.innerHTML.split('<br><br>');
            if (entries.length > 50) {
                logEl.innerHTML = entries.slice(0, 50).join('<br><br>');
            }
        }
        
        function syncSliderFromInput(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            if (slider && input) {
                slider.value = input.value;
            }
        }
        
        function syncInputFromSlider(sliderId, inputId) {
            const slider = document.getElementById(sliderId);
            const input = document.getElementById(inputId);
            if (slider && input) {
                input.value = slider.value;
            }
        }
        
        // Handle file input
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadImageFile(file);
            }
        });
        
        function loadImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    processImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function processImage(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size (maintain aspect ratio)
            const maxWidth = 800;
            const maxHeight = 600;
            let { width, height } = img;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(img, 0, 0, width, height);
            originalImageData = ctx.getImageData(0, 0, width, height);
            
            // Set the aspect ratio for both demo containers
            const aspectRatio = width / height;
            document.documentElement.style.setProperty('--image-aspect-ratio', aspectRatio);
            
            log(`Image loaded: ${width}x${height} (aspect ratio: ${aspectRatio.toFixed(2)})`);
            
            // Automatically start generation
            setTimeout(() => {
                generateWithCallbacks();
            }, 100);
        }
        
        async function generateWithCallbacks() {
            if (!originalImageData) {
                alert('Please load an image first!');
                return;
            }
            
            log('üöÄ Starting img2css generation with plugin callbacks...');
            
            // Reset plugin data
            specularPixels = [];
            reflectionPixels = [];
            shadowPixels = [];
            totalPixelsProcessed = 0;
            totalRowsProcessed = 0;
            totalColumnsProcessed = 0;
            
            // Create blob URL from image data
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = originalImageData.width;
            canvas.height = originalImageData.height;
            ctx.putImageData(originalImageData, 0, 0);
            
            canvas.toBlob(async (blob) => {
                const imageUrl = URL.createObjectURL(blob);
                
                try {
                    log('üìä Generating CSS with tone analysis...');
                    
                    // Create img2css instance with callbacks and source
                    const img2cssInstance = new img2css({
                        source: imageUrl,
                        onPixelProcess: onPixelProcessCallback,
                        onRowProcess: onRowProcessCallback,
                        onColumnProcess: onColumnProcessCallback
                    });
                    
                    // Generate CSS (this will trigger all our callbacks)
                    const cssResult = await img2cssInstance.toCSS();
                    
                    log(`‚úÖ Generation complete! Processed ${totalPixelsProcessed} pixels, ${totalRowsProcessed} rows, ${totalColumnsProcessed} columns`);
                    
                    // Apply base gradient
                    applyBaseGradient(cssResult);
                    
                    // Generate tone masks from captured data
                    const masks = await generateToneMasksFromCallbackData();
                    
                    // Apply enhanced layers
                    applyEnhancedLayers(masks);
                    
                    // Update statistics
                    updateStats();
                    
                    // Clean up
                    URL.revokeObjectURL(imageUrl);
                    
                } catch (error) {
                    log(`‚ùå Error: ${error.message}`);
                }
            });
        }
        
        function onPixelProcessCallback(pixelData) {
            totalPixelsProcessed++;
            
            // Classify pixel by tone (same logic as previous prototypes)
            const { r, g, b } = pixelData;
            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
            
            const specularThreshold = 180; // Lowered to catch more highlights
            const shadowThreshold = 80;
            
            if (gray >= specularThreshold) {
                specularPixels.push({
                    x: pixelData.x,
                    y: pixelData.y,
                    intensity: gray / 255,
                    position: pixelData.position,
                    isRow: pixelData.isRow
                });
            } else if (gray <= shadowThreshold) {
                shadowPixels.push({
                    x: pixelData.x,
                    y: pixelData.y,
                    intensity: (255 - gray) / 255,
                    position: pixelData.position,
                    isRow: pixelData.isRow
                });
            } else {
                reflectionPixels.push({
                    x: pixelData.x,
                    y: pixelData.y,
                    intensity: (Math.abs(gray - 127.5) / 127.5),
                    position: pixelData.position,
                    isRow: pixelData.isRow
                });
            }
        }
        
        function onRowProcessCallback(rowData) {
            totalRowsProcessed++;
            log(`üìè Processed row ${rowData.y} with ${rowData.stops.length} color stops`);
        }
        
        function onColumnProcessCallback(columnData) {
            totalColumnsProcessed++;
            log(`üìê Processed column ${columnData.x} with ${columnData.stops.length} color stops`);
        }
        
        function applyBaseGradient(cssResult) {
            // cssResult should be the full CSS string, we need to extract just the gradient
            let gradientValue = cssResult;
            
            // If it's a full CSS rule, extract just the background value
            if (cssResult.includes('background:')) {
                const match = cssResult.match(/background:\s*([^;]+)/);
                if (match) {
                    gradientValue = match[1].trim();
                }
            }
            
            // Only apply to the enhanced version now
            document.getElementById('layerBaseEnhanced').style.background = gradientValue;
            log(`üé® Applied base gradient: ${gradientValue.substring(0, 100)}...`);
        }
        
        async function generateToneMasksFromCallbackData() {
            // Generate each mask with its individual settings
            const specularMask = await generateSpecularMaskWithControls();
            const reflectionMask = await generateReflectionMaskWithControls();
            const shadowMask = await generateShadowMaskWithControls();
            
            log(`üé≠ Generated individual masks with current settings`);
            
            return {
                specular: specularMask,
                reflection: reflectionMask,
                shadow: shadowMask
            };
        }
        
        function createMaskFromPixels(pixels, width, height) {
            // Just return the base grayscale mask - sliders will handle the processing
            return generateGrayscaleMask(width, height);
        }
        
        function generateGrayscaleMask(width, height) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            
            // Create ImageData for the mask
            const imageData = ctx.createImageData(width, height);
            const data = imageData.data;
            
            if (originalImageData) {
                const originalData = originalImageData.data;
                const originalWidth = originalImageData.width;
                const originalHeight = originalImageData.height;
                
                // Scale factor between original image and mask
                const scaleX = originalWidth / width;
                const scaleY = originalHeight / height;
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        // Sample from original image
                        const origX = Math.floor(x * scaleX);
                        const origY = Math.floor(y * scaleY);
                        const origIndex = (origY * originalWidth + origX) * 4;
                        
                        if (origIndex < originalData.length - 3) {
                            const r = originalData[origIndex];
                            const g = originalData[origIndex + 1];
                            const b = originalData[origIndex + 2];
                            
                            // Convert to grayscale
                            const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                            
                            const maskIndex = (y * width + x) * 4;
                            data[maskIndex] = gray;     // R
                            data[maskIndex + 1] = gray; // G
                            data[maskIndex + 2] = gray; // B
                            data[maskIndex + 3] = 255;  // A
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas.toDataURL();
        }
        
        function applyEnhancedLayers(masks) {
            const demo = document.getElementById('enhancedDemo');
            
            // Save masks for invert toggles
            toneMaskData = masks;
            
            // Display mask previews
            displayMaskPreview('specularMaskCanvas', masks.specular);
            displayMaskPreview('reflectionMaskCanvas', masks.reflection);
            displayMaskPreview('shadowMaskCanvas', masks.shadow);
            
            // Apply masks using CSS mask properties for better masking
            const specularLayer = document.getElementById('layerToneSpecular');
            const reflectionLayer = document.getElementById('layerToneReflection');
            const shadowLayer = document.getElementById('layerToneShadow');
            
            if (specularLayer) {
                specularLayer.style.maskImage = `url('${masks.specular}')`;
                specularLayer.style.maskMode = 'luminance';
                specularLayer.style.maskSize = '100% 100%';
            }
            
            if (reflectionLayer) {
                reflectionLayer.style.maskImage = `url('${masks.reflection}')`;
                reflectionLayer.style.maskMode = 'luminance';
                reflectionLayer.style.maskSize = '100% 100%';
            }
            
            if (shadowLayer) {
                shadowLayer.style.maskImage = `url('${masks.shadow}')`;
                shadowLayer.style.maskMode = 'luminance';
                shadowLayer.style.maskSize = '100% 100%';
            }
            
            // Apply initial effect colors and opacities
            updateEffects();
            
            log('‚ú® Applied enhanced tone layers with perfect alignment using shader structure!');
        }
        
        async function updateSpecularMask() {
            // Update slider value displays
            document.getElementById('specularWhitePointValue').textContent = document.getElementById('specularWhitePointSlider').value;
            document.getElementById('specularBlackPointValue').textContent = document.getElementById('specularBlackPointSlider').value;
            document.getElementById('specularContrastValue').textContent = document.getElementById('specularContrastSlider').value;
            
            // Regenerate specular mask with new settings
            if (originalImageData) {
                const newSpecularMask = await generateSpecularMaskWithControls();
                
                // Apply the new mask (invert is already baked in)
                const specularLayer = document.getElementById('layerToneSpecular');
                if (specularLayer) {
                    specularLayer.style.maskImage = `url('${newSpecularMask}')`;
                }
                
                const finalMask = newSpecularMask;
                
                // Update mask preview
                displayMaskPreview('specularMaskCanvas', finalMask);
                
                log(`üé≠ Updated specular mask: white=${document.getElementById('specularWhitePointSlider').value}, black=${document.getElementById('specularBlackPointSlider').value}, contrast=${document.getElementById('specularContrastSlider').value}`);
            }
        }
        
        function updateSpecularBlur() {
            // Update slider value display
            const blurValue = document.getElementById('specularBlurSlider').value;
            document.getElementById('specularBlurValue').textContent = blurValue;
            
            // Regenerate the entire mask since blur is now baked in
            updateSpecularMask();
            
            log(`üåü Updated specular blur: ${blurValue}px`);
        }
        
        async function updateReflectionMask() {
            // Update slider value displays
            document.getElementById('reflectionWhitePointValue').textContent = document.getElementById('reflectionWhitePointSlider').value;
            document.getElementById('reflectionBlackPointValue').textContent = document.getElementById('reflectionBlackPointSlider').value;
            document.getElementById('reflectionContrastValue').textContent = document.getElementById('reflectionContrastSlider').value;
            
            // Regenerate reflection mask with new settings
            if (originalImageData) {
                const newReflectionMask = await generateReflectionMaskWithControls();
                
                // Apply the new mask (invert is already baked in)
                const reflectionLayer = document.getElementById('layerToneReflection');
                if (reflectionLayer) {
                    reflectionLayer.style.maskImage = `url('${newReflectionMask}')`;
                }
                
                const finalMask = newReflectionMask;
                
                // Update mask preview
                displayMaskPreview('reflectionMaskCanvas', finalMask);
                
                log(`üí´ Updated reflection mask: white=${document.getElementById('reflectionWhitePointSlider').value}, black=${document.getElementById('reflectionBlackPointSlider').value}, contrast=${document.getElementById('reflectionContrastSlider').value}`);
            }
        }
        
        function updateReflectionBlur() {
            // Update slider value display
            const blurValue = document.getElementById('reflectionBlurSlider').value;
            document.getElementById('reflectionBlurValue').textContent = blurValue;
            
            // Regenerate the entire mask since blur is now baked in
            updateReflectionMask();
            
            log(`üí´ Updated reflection blur: ${blurValue}px`);
        }
        
        async function updateShadowMask() {
            // Update slider value displays
            document.getElementById('shadowWhitePointValue').textContent = document.getElementById('shadowWhitePointSlider').value;
            document.getElementById('shadowBlackPointValue').textContent = document.getElementById('shadowBlackPointSlider').value;
            document.getElementById('shadowContrastValue').textContent = document.getElementById('shadowContrastSlider').value;
            
            // Regenerate shadow mask with new settings
            if (originalImageData) {
                const newShadowMask = await generateShadowMaskWithControls();
                
                // Apply the new mask (invert is already baked in)
                const shadowLayer = document.getElementById('layerToneShadow');
                if (shadowLayer) {
                    shadowLayer.style.maskImage = `url('${newShadowMask}')`;
                }
                
                const finalMask = newShadowMask;
                
                // Update mask preview
                displayMaskPreview('shadowMaskCanvas', finalMask);
                
                log(`üåë Updated shadow mask: white=${document.getElementById('shadowWhitePointSlider').value}, black=${document.getElementById('shadowBlackPointSlider').value}, contrast=${document.getElementById('shadowContrastSlider').value}`);
            }
        }
        
        function updateShadowBlur() {
            // Update slider value display
            const blurValue = document.getElementById('shadowBlurSlider').value;
            document.getElementById('shadowBlurValue').textContent = blurValue;
            
            // Regenerate the entire mask since blur is now baked in
            updateShadowMask();
            
            log(`üåë Updated shadow blur: ${blurValue}px`);
        }
        
        function updateEffects() {
            // Update slider value displays
            document.getElementById('specularOpacityValue').textContent = document.getElementById('specularOpacity').value;
            document.getElementById('reflectionOpacityValue').textContent = document.getElementById('reflectionOpacity').value;
            document.getElementById('reflectionAngleValue').textContent = document.getElementById('reflectionAngleSlider').value;
            document.getElementById('shadowOpacityValue').textContent = document.getElementById('shadowOpacity').value;
            document.getElementById('specularAngleValue').textContent = document.getElementById('specularAngleSlider').value;
            
            // Specular gradient values
            document.getElementById('specularAlpha1Value').textContent = 'Œ± ' + document.getElementById('specularAlpha1').value;
            document.getElementById('specularAlpha2Value').textContent = 'Œ± ' + document.getElementById('specularAlpha2').value;
            document.getElementById('specularAlpha3Value').textContent = 'Œ± ' + document.getElementById('specularAlpha3').value;
            document.getElementById('specularPos1Value').textContent = document.getElementById('specularPos1').value;
            document.getElementById('specularPos2Value').textContent = document.getElementById('specularPos2').value;
            document.getElementById('specularPos3Value').textContent = document.getElementById('specularPos3').value;
            
            // Reflection gradient values
            document.getElementById('reflectionAlpha1Value').textContent = 'Œ± ' + document.getElementById('reflectionAlpha1').value;
            document.getElementById('reflectionAlpha2Value').textContent = 'Œ± ' + document.getElementById('reflectionAlpha2').value;
            document.getElementById('reflectionAlpha3Value').textContent = 'Œ± ' + document.getElementById('reflectionAlpha3').value;
            document.getElementById('reflectionPos1Value').textContent = document.getElementById('reflectionPos1').value;
            document.getElementById('reflectionPos2Value').textContent = document.getElementById('reflectionPos2').value;
            document.getElementById('reflectionPos3Value').textContent = document.getElementById('reflectionPos3').value;
            
            // Shadow gradient values  
            document.getElementById('shadowAlpha1Value').textContent = 'Œ± ' + document.getElementById('shadowAlpha1').value;
            document.getElementById('shadowAlpha2Value').textContent = 'Œ± ' + document.getElementById('shadowAlpha2').value;
            document.getElementById('shadowAlpha3Value').textContent = 'Œ± ' + document.getElementById('shadowAlpha3').value;
            document.getElementById('shadowPos1Value').textContent = document.getElementById('shadowPos1').value;
            document.getElementById('shadowPos2Value').textContent = document.getElementById('shadowPos2').value;
            document.getElementById('shadowPos3Value').textContent = document.getElementById('shadowPos3').value;
            
            // Sync numeric inputs with sliders
            syncInputFromSlider('specularAlpha1', 'specularAlpha1Input');
            syncInputFromSlider('specularAlpha2', 'specularAlpha2Input');
            syncInputFromSlider('specularAlpha3', 'specularAlpha3Input');
            syncInputFromSlider('specularPos1', 'specularPos1Input');
            syncInputFromSlider('specularPos2', 'specularPos2Input');
            syncInputFromSlider('specularPos3', 'specularPos3Input');
            syncInputFromSlider('specularOpacity', 'specularOpacityInput');
            syncInputFromSlider('specularAngleSlider', 'specularAngleInput');
            syncInputFromSlider('reflectionAlpha1', 'reflectionAlpha1Input');
            syncInputFromSlider('reflectionAlpha2', 'reflectionAlpha2Input');
            syncInputFromSlider('reflectionAlpha3', 'reflectionAlpha3Input');
            syncInputFromSlider('reflectionPos1', 'reflectionPos1Input');
            syncInputFromSlider('reflectionPos2', 'reflectionPos2Input');
            syncInputFromSlider('reflectionPos3', 'reflectionPos3Input');
            syncInputFromSlider('reflectionOpacity', 'reflectionOpacityInput');
            syncInputFromSlider('reflectionAngleSlider', 'reflectionAngleInput');
            syncInputFromSlider('shadowAlpha1', 'shadowAlpha1Input');
            syncInputFromSlider('shadowAlpha2', 'shadowAlpha2Input');
            syncInputFromSlider('shadowAlpha3', 'shadowAlpha3Input');
            syncInputFromSlider('shadowPos1', 'shadowPos1Input');
            syncInputFromSlider('shadowPos2', 'shadowPos2Input');
            syncInputFromSlider('shadowPos3', 'shadowPos3Input');
            
            // Get color and opacity values
            const specularColor1 = document.getElementById('specularColor1').value;
            const specularColor2 = document.getElementById('specularColor2').value;
            const specularColor3 = document.getElementById('specularColor3').value;
            const specularAlpha1 = document.getElementById('specularAlpha1').value;
            const specularAlpha2 = document.getElementById('specularAlpha2').value;
            const specularAlpha3 = document.getElementById('specularAlpha3').value;
            const specularPos1 = document.getElementById('specularPos1').value;
            const specularPos2 = document.getElementById('specularPos2').value;
            const specularPos3 = document.getElementById('specularPos3').value;
            const specularOpacity = document.getElementById('specularOpacity').value;
            const specularAngle = document.getElementById('specularAngleSlider').value;
            
            const reflectionColor1 = document.getElementById('reflectionColor1').value;
            const reflectionColor2 = document.getElementById('reflectionColor2').value;
            const reflectionColor3 = document.getElementById('reflectionColor3').value;
            const reflectionAlpha1 = document.getElementById('reflectionAlpha1').value;
            const reflectionAlpha2 = document.getElementById('reflectionAlpha2').value;
            const reflectionAlpha3 = document.getElementById('reflectionAlpha3').value;
            const reflectionPos1 = document.getElementById('reflectionPos1').value;
            const reflectionPos2 = document.getElementById('reflectionPos2').value;
            const reflectionPos3 = document.getElementById('reflectionPos3').value;
            const reflectionOpacity = document.getElementById('reflectionOpacity').value;
            const reflectionAngle = document.getElementById('reflectionAngleSlider').value;
            
            const shadowColor1 = document.getElementById('shadowColor1').value;
            const shadowColor2 = document.getElementById('shadowColor2').value;
            const shadowColor3 = document.getElementById('shadowColor3').value;
            const shadowAlpha1 = document.getElementById('shadowAlpha1').value;
            const shadowAlpha2 = document.getElementById('shadowAlpha2').value;
            const shadowAlpha3 = document.getElementById('shadowAlpha3').value;
            const shadowPos1 = document.getElementById('shadowPos1').value;
            const shadowPos2 = document.getElementById('shadowPos2').value;
            const shadowPos3 = document.getElementById('shadowPos3').value;
            const shadowOpacity = document.getElementById('shadowOpacity').value;
            
            // Get blend mode values
            const specularBlendMode = document.getElementById('specularBlendMode').value;
            const reflectionBlendMode = document.getElementById('reflectionBlendMode').value;
            const shadowBlendMode = document.getElementById('shadowBlendMode').value;
            
            // Convert hex colors to RGB
            const specularRGB1 = hexToRgb(specularColor1);
            const specularRGB2 = hexToRgb(specularColor2);
            const specularRGB3 = hexToRgb(specularColor3);
            const reflectionRGB1 = hexToRgb(reflectionColor1);
            const reflectionRGB2 = hexToRgb(reflectionColor2);
            const reflectionRGB3 = hexToRgb(reflectionColor3);
            const shadowRGB1 = hexToRgb(shadowColor1);
            const shadowRGB2 = hexToRgb(shadowColor2);
            const shadowRGB3 = hexToRgb(shadowColor3);
            
            // Apply gradients to shader layers using CodePen pattern with RGBA
            const specularLayer = document.getElementById('layerToneSpecular');
            const reflectionLayer = document.getElementById('layerToneReflection');
            const shadowLayer = document.getElementById('layerToneShadow');
            
            if (specularLayer && sectionEnabledStates.specular) {
                const gradientCSS = `linear-gradient(${specularAngle}deg, rgba(${specularRGB1.r},${specularRGB1.g},${specularRGB1.b},${specularAlpha1}) ${specularPos1}%, rgba(${specularRGB2.r},${specularRGB2.g},${specularRGB2.b},${specularAlpha2}) ${specularPos2}%, rgba(${specularRGB3.r},${specularRGB3.g},${specularRGB3.b},${specularAlpha3}) ${specularPos3}%)`;
                specularLayer.style.backgroundImage = gradientCSS;
                specularLayer.style.mixBlendMode = specularBlendMode;
                specularLayer.style.opacity = specularOpacity;
                specularLayer.style.display = 'block';
            } else if (specularLayer) {
                specularLayer.style.display = 'none';
            }
            
            if (reflectionLayer && sectionEnabledStates.reflection) {
                const gradientCSS = `linear-gradient(${reflectionAngle}deg, rgba(${reflectionRGB1.r},${reflectionRGB1.g},${reflectionRGB1.b},${reflectionAlpha1}) ${reflectionPos1}%, rgba(${reflectionRGB2.r},${reflectionRGB2.g},${reflectionRGB2.b},${reflectionAlpha2}) ${reflectionPos2}%, rgba(${reflectionRGB3.r},${reflectionRGB3.g},${reflectionRGB3.b},${reflectionAlpha3}) ${reflectionPos3}%)`;
                reflectionLayer.style.backgroundImage = gradientCSS;
                reflectionLayer.style.mixBlendMode = reflectionBlendMode;
                reflectionLayer.style.opacity = reflectionOpacity;
                reflectionLayer.style.display = 'block';
            } else if (reflectionLayer) {
                reflectionLayer.style.display = 'none';
            }
            
            if (shadowLayer && sectionEnabledStates.shadow) {
                const gradientCSS = `linear-gradient(to bottom, rgba(${shadowRGB1.r},${shadowRGB1.g},${shadowRGB1.b},${shadowAlpha1}) ${shadowPos1}%, rgba(${shadowRGB2.r},${shadowRGB2.g},${shadowRGB2.b},${shadowAlpha2}) ${shadowPos2}%, rgba(${shadowRGB3.r},${shadowRGB3.g},${shadowRGB3.b},${shadowAlpha3}) ${shadowPos3}%)`;
                shadowLayer.style.backgroundImage = gradientCSS;
                shadowLayer.style.mixBlendMode = shadowBlendMode;
                shadowLayer.style.opacity = shadowOpacity;
                shadowLayer.style.display = 'block';
            } else if (shadowLayer) {
                shadowLayer.style.display = 'none';
            }
            
            log(`üé® Updated 3-part gradients: Specular [${specularPos1}%-${specularPos2}%-${specularPos3}%] @${specularOpacity} (${specularBlendMode}), Reflection [${reflectionPos1}%-${reflectionPos2}%-${reflectionPos3}%] @${reflectionOpacity} (${reflectionBlendMode}), Shadow [${shadowPos1}%-${shadowPos2}%-${shadowPos3}%] @${shadowOpacity} (${shadowBlendMode})`);
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function toggleInvert(maskType) {
            maskInvertStates[maskType] = !maskInvertStates[maskType];
            const button = document.getElementById(`${maskType}Invert`);
            
            if (maskInvertStates[maskType]) {
                button.classList.add('active');
                button.textContent = 'Inverted';
            } else {
                button.classList.remove('active');
                button.textContent = 'Invert';
            }
            
            // Regenerate and apply masks with new invert state
            if (originalImageData && toneMaskData) {
                const masks = generateToneMasksFromCallbackData();
                applyMasksWithInvertStates(masks);
            }
            
            log(`üîÑ Toggled ${maskType} mask invert: ${maskInvertStates[maskType] ? 'ON' : 'OFF'}`);
        }
        
        async function applyMasksWithInvertStates(masks) {
            // Regenerate all masks since invert is now baked into the generation
            if (originalImageData && toneMaskData) {
                const newMasks = await generateToneMasksFromCallbackData();
                applyEnhancedLayers(newMasks);
            }
        }
        
        function invertMask(maskDataUrl) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Invert each pixel
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];         // R
                        data[i + 1] = 255 - data[i + 1]; // G
                        data[i + 2] = 255 - data[i + 2]; // B
                        // Keep alpha the same
                    }
                    
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL());
                };
                img.src = maskDataUrl;
            });
        }
        
        function displayMaskPreview(canvasId, maskDataUrl) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                const scale = Math.min(200 / img.width, 150 / img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = maskDataUrl;
        }
        
        function updateStats() {
            const specularPercentage = ((specularPixels.length / totalPixelsProcessed) * 100).toFixed(1);
            const reflectionPercentage = ((reflectionPixels.length / totalPixelsProcessed) * 100).toFixed(1);
            const shadowPercentage = ((shadowPixels.length / totalPixelsProcessed) * 100).toFixed(1);
            
            const headerStatsHtml = `
                <div class="stat-line">Pixels: ${totalPixelsProcessed.toLocaleString()}</div>
                <div class="stat-line">Specular: ${specularPercentage}% | Reflection: ${reflectionPercentage}% | Shadow: ${shadowPercentage}%</div>
                <div class="stat-line">Rows: ${totalRowsProcessed} | Columns: ${totalColumnsProcessed}</div>
                <div class="stat-line">‚úÖ Perfect alignment guaranteed</div>
            `;
            document.getElementById('headerStats').innerHTML = headerStatsHtml;
        }
        
        function toggleSection(sectionType) {
            const section = document.getElementById(`${sectionType}Section`);
            const toggle = document.getElementById(`${sectionType}Toggle`);
            const layer = document.getElementById(`layerTone${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)}`);
            
            sectionEnabledStates[sectionType] = !sectionEnabledStates[sectionType];
            
            if (sectionEnabledStates[sectionType]) {
                // Enable section
                section.classList.remove('disabled');
                toggle.classList.remove('disabled');
                if (layer) layer.style.display = 'block';
            } else {
                // Disable section
                section.classList.add('disabled');
                toggle.classList.add('disabled');
                if (layer) layer.style.display = 'none';
            }
            
            log(`üîÑ ${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)} section ${sectionEnabledStates[sectionType] ? 'enabled' : 'disabled'}`);
        }
        
        function toggleCollapse(sectionType) {
            const section = document.getElementById(`${sectionType}Section`);
            const collapseBtn = document.getElementById(`${sectionType}CollapseBtn`);
            const controlPanel = document.getElementById(`${sectionType}ControlPanel`);
            
            sectionCollapsedStates[sectionType] = !sectionCollapsedStates[sectionType];
            
            if (sectionCollapsedStates[sectionType]) {
                // Collapse section - hide control panel
                section.classList.add('collapsed');
            } else {
                // Expand section - show control panel
                section.classList.remove('collapsed');
            }
            
            log(`üìÅ ${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)} section ${sectionCollapsedStates[sectionType] ? 'collapsed' : 'expanded'}`);
        }
        
        function toggleLayer(layerId) {
            const layer = document.getElementById(layerId);
            const button = event.target;
            
            if (layer.style.display === 'none') {
                layer.style.display = 'block';
                button.classList.remove('disabled');
            } else {
                layer.style.display = 'none';
                button.classList.add('disabled');
            }
        }
        
        async function generateSpecularMaskWithControls() {
            if (!originalImageData) return null;
            
            const whitePoint = parseInt(document.getElementById('specularWhitePointSlider').value);
            const blackPoint = parseInt(document.getElementById('specularBlackPointSlider').value);
            const contrast = parseFloat(document.getElementById('specularContrastSlider').value);
            const blurAmount = parseFloat(document.getElementById('specularBlurSlider').value);
            const shouldInvert = maskInvertStates.specular;
            
            // Generate base mask with all controls applied including invert
            let baseMask = generateMaskWithPoints(whitePoint, blackPoint, contrast, shouldInvert);
            
            // Apply blur if needed
            if (blurAmount > 0) {
                baseMask = await applyBlurToMask(baseMask, blurAmount);
            }
            
            return baseMask;
        }
        
        async function generateReflectionMaskWithControls() {
            if (!originalImageData) return null;
            
            const whitePoint = parseInt(document.getElementById('reflectionWhitePointSlider').value);
            const blackPoint = parseInt(document.getElementById('reflectionBlackPointSlider').value);
            const contrast = parseFloat(document.getElementById('reflectionContrastSlider').value);
            const blurAmount = parseFloat(document.getElementById('reflectionBlurSlider').value);
            const shouldInvert = maskInvertStates.reflection;
            
            // Generate base mask with all controls applied including invert
            let baseMask = generateMaskWithPoints(whitePoint, blackPoint, contrast, shouldInvert);
            
            // Apply blur if needed
            if (blurAmount > 0) {
                baseMask = await applyBlurToMask(baseMask, blurAmount);
            }
            
            return baseMask;
        }
        
        async function generateShadowMaskWithControls() {
            if (!originalImageData) return null;
            
            const whitePoint = parseInt(document.getElementById('shadowWhitePointSlider').value);
            const blackPoint = parseInt(document.getElementById('shadowBlackPointSlider').value);
            const contrast = parseFloat(document.getElementById('shadowContrastSlider').value);
            const blurAmount = parseFloat(document.getElementById('shadowBlurSlider').value);
            const shouldInvert = maskInvertStates.shadow;
            
            // Generate base mask with all controls applied including invert
            let baseMask = generateMaskWithPoints(whitePoint, blackPoint, contrast, shouldInvert);
            
            // Apply blur if needed
            if (blurAmount > 0) {
                baseMask = await applyBlurToMask(baseMask, blurAmount);
            }
            
            return baseMask;
        }
        
        function generateMaskWithPoints(whitePoint, blackPoint, contrast, shouldInvert = false) {
            if (!originalImageData) {
                log('‚ùå No original image data available for mask generation');
                return null;
            }
            
            const width = originalImageData.width;
            const height = originalImageData.height;
            const data = originalImageData.data;
            
            log(`üîß Generating mask: ${width}x${height}, white=${whitePoint}, black=${blackPoint}, contrast=${contrast}, invert=${shouldInvert}`);
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            
            const imageData = ctx.createImageData(width, height);
            const maskData = imageData.data;
            
            let minGray = 255, maxGray = 0, totalGray = 0, pixelCount = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Convert to grayscale
                let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // Track statistics
                minGray = Math.min(minGray, gray);
                maxGray = Math.max(maxGray, gray);
                totalGray += gray;
                pixelCount++;
                
                // Apply contrast enhancement
                gray = ((gray - 128) * contrast) + 128;
                gray = Math.max(0, Math.min(255, gray));
                
                // Apply white point and black point clamping
                let maskValue;
                if (blackPoint >= whitePoint) {
                    // Avoid division by zero or negative range
                    maskValue = gray >= whitePoint ? 255 : 0;
                } else {
                    // Clamp and remap: blackPoint becomes 0, whitePoint becomes 255
                    if (gray <= blackPoint) {
                        maskValue = 0;
                    } else if (gray >= whitePoint) {
                        maskValue = 255;
                    } else {
                        // Linear interpolation between black and white points
                        const range = whitePoint - blackPoint;
                        const normalizedGray = (gray - blackPoint) / range;
                        maskValue = Math.round(normalizedGray * 255);
                    }
                }
                
                // Apply invert if requested
                if (shouldInvert) {
                    maskValue = 255 - maskValue;
                }
                
                maskData[i] = maskValue;     // R
                maskData[i + 1] = maskValue; // G  
                maskData[i + 2] = maskValue; // B
                maskData[i + 3] = 255;       // A
            }
            
            const avgGray = totalGray / pixelCount;
            log(`üìä Mask stats: gray range ${minGray.toFixed(1)}-${maxGray.toFixed(1)}, avg=${avgGray.toFixed(1)}, ${pixelCount} pixels processed`);
            
            ctx.putImageData(imageData, 0, 0);
            const dataUrl = canvas.toDataURL();
            
            log(`‚úÖ Generated mask data URL: ${dataUrl.substring(0, 50)}... (length: ${dataUrl.length})`);
            
            return dataUrl;
        }
        
        function applyBlurToMask(maskDataUrl, blurAmount) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Set canvas dimensions to match the loaded image
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Apply blur filter and draw
                    ctx.filter = `blur(${blurAmount}px)`;
                    ctx.drawImage(img, 0, 0);
                    
                    resolve(canvas.toDataURL());
                };
                
                img.onerror = function() {
                    log('‚ùå Error loading mask image for blur');
                    resolve(maskDataUrl); // Return original if blur fails
                };
                
                img.src = maskDataUrl;
            });
        }
        
        function invertMaskData(canvas) {
            // Invert the canvas data directly
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Invert each pixel
            for (let i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i];         // R
                data[i + 1] = 255 - data[i + 1]; // G
                data[i + 2] = 255 - data[i + 2]; // B
                // Keep alpha the same
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas.toDataURL();
        }
        
        // Initialize button states based on default invert states
        function initializeButtonStates() {
            Object.keys(maskInvertStates).forEach(maskType => {
                const button = document.getElementById(`${maskType}Invert`);
                if (button && maskInvertStates[maskType]) {
                    button.classList.add('active');
                    button.textContent = 'Inverted';
                }
            });
        }
        
        // Initialize on page load
        initializeButtonStates();
        
        log('üîß Plugin system ready! Load an image to test the callback system.');
    </script>
</body>
</html>